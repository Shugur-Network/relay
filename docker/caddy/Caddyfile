# Caddyfile for Shugur Relay - Standalone Installation
# Auto-generated configuration for complete reverse proxy setup
# This handles all HTTP/HTTPS traffic routing and SSL certificates automatically
# NOTE: Metrics endpoint is secured internally for maximum security

shu02.shugur.net {
    # Reverse proxy to relay WebSocket server
    reverse_proxy relay:8080 {
        # Full WebSocket support with proper headers
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # Security headers - applied at proxy level for all responses
    header {
        # HTTP Strict Transport Security - enforce HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Prevent MIME sniffing
        X-Content-Type-Options "nosniff"
        
        # Clickjacking protection - allow same origin for dashboard
        X-Frame-Options "SAMEORIGIN"
        
        # Referrer policy for privacy
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # XSS Protection (legacy but useful)
        X-XSS-Protection "1; mode=block"
        
        # Remove server information headers
        -Server
        -X-Powered-By
    }
    
    # Enable compression for better performance
    encode gzip zstd
    
    # Automatic HTTPS with Let's Encrypt (disabled for localhost)
    # Production domains get automatic SSL certificates
    
    # Comprehensive access logging
    log {
        output file /var/log/caddy/access.log
        format json
    }
    
    # Professional error handling
    handle_errors {
        respond "Shugur Relay temporarily unavailable - please try again shortly" 503
    }
}

# SECURITY: Metrics endpoint (8181) is intentionally NOT exposed externally
# This ensures your relay metrics remain private and secure
# Access metrics internally: docker exec relay-dev curl http://localhost:8181/metrics
