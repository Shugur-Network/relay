name: "Enhanced Release Notes"

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to enhance'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: read

jobs:
  enhance-release-notes:
    name: Enhance Release Notes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      
      - name: Set release tag
        id: set-tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate enhanced release notes
        id: release-notes
        run: |
          TAG="${{ steps.set-tag.outputs.tag }}"
          
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${TAG}^)
          
          echo "## ðŸš€ What's New in ${TAG}" > enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          # Get commit range
          COMMITS=$(git log ${PREV_TAG}..${TAG} --oneline --no-merges)
          
          # Categorize changes
          echo "### âœ¨ Features" >> enhanced_notes.md
          echo "$COMMITS" | grep -i "feat\|feature" | sed 's/^/- /' >> enhanced_notes.md || echo "- No new features in this release" >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          echo "### ðŸ› Bug Fixes" >> enhanced_notes.md
          echo "$COMMITS" | grep -i "fix\|bug" | sed 's/^/- /' >> enhanced_notes.md || echo "- No bug fixes in this release" >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          echo "### ðŸ“š Documentation" >> enhanced_notes.md
          echo "$COMMITS" | grep -i "docs\|documentation" | sed 's/^/- /' >> enhanced_notes.md || echo "- No documentation changes in this release" >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          echo "### ðŸ”§ Maintenance" >> enhanced_notes.md
          echo "$COMMITS" | grep -i "chore\|refactor\|perf" | sed 's/^/- /' >> enhanced_notes.md || echo "- No maintenance changes in this release" >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          # Add contributors
          echo "### ðŸ‘¥ Contributors" >> enhanced_notes.md
          git log ${PREV_TAG}..${TAG} --format='%aN' | sort -u | sed 's/^/- @/' >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          # Add installation instructions
          echo "### ðŸ“¦ Installation" >> enhanced_notes.md
          echo '```bash' >> enhanced_notes.md
          echo "# Download binary" >> enhanced_notes.md
          echo "wget https://github.com/Shugur-Network/relay/releases/download/${TAG}/relay-linux-amd64" >> enhanced_notes.md
          echo "chmod +x relay-linux-amd64" >> enhanced_notes.md
          echo "sudo mv relay-linux-amd64 /usr/local/bin/relay" >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          echo "# Or build from source" >> enhanced_notes.md
          echo "git clone https://github.com/Shugur-Network/relay.git" >> enhanced_notes.md
          echo "cd relay" >> enhanced_notes.md
          echo "git checkout ${TAG}" >> enhanced_notes.md
          echo "go build -o relay ./cmd" >> enhanced_notes.md
          echo '```' >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          # Add checksums if available
          echo "### ðŸ” Checksums" >> enhanced_notes.md
          echo "SHA256 checksums will be available shortly after release publication." >> enhanced_notes.md
          echo "" >> enhanced_notes.md
          
          echo "### ðŸ“Š Release Statistics" >> enhanced_notes.md
          COMMIT_COUNT=$(git rev-list --count ${PREV_TAG}..${TAG})
          FILES_CHANGED=$(git diff --name-only ${PREV_TAG}..${TAG} | wc -l)
          echo "- **Commits**: ${COMMIT_COUNT}" >> enhanced_notes.md
          echo "- **Files Changed**: ${FILES_CHANGED}" >> enhanced_notes.md
          echo "- **Release Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> enhanced_notes.md
          
          cat enhanced_notes.md
      
      - name: Update GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.set-tag.outputs.tag }}"
          
          # Get current release notes
          CURRENT_NOTES=$(gh release view ${TAG} --json body -q .body)
          
          # Combine enhanced notes with existing ones
          {
            cat enhanced_notes.md
            echo ""
            echo "---"
            echo ""
            echo "$CURRENT_NOTES"
          } > combined_notes.md
          
          # Update the release
          gh release edit ${TAG} --notes-file combined_notes.md
          
          echo "âœ… Enhanced release notes for ${TAG}"